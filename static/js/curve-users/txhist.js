const transactionProductList = ["All", "Trading", "UI Router", "LP", "Lending", "crvUSD", "DAO"];
const transactionHistogramData = {'ethereum': {'All': [['1', 30780],
            ['2', 14452],
            ['3', 7050],
            ['4', 3935],
            ['5', 2288],
            ['6', 1448],
            ['7', 986],
            ['8', 644],
            ['9+', 3442]],
        'Trading': [['1', 16447],
            ['2', 5022],
            ['3', 1584],
            ['4', 663],
            ['5', 323],
            ['6', 184],
            ['7', 99],
            ['8', 97],
            ['9+', 665]],
        'UI Router': [['1', 17271],
            ['2', 4241],
            ['3', 1648],
            ['4', 826],
            ['5', 535],
            ['6', 339],
            ['7', 235],
            ['8', 167],
            ['9+', 963]],
        'LP': [['1', 12411],
            ['2', 11018],
            ['3', 2424],
            ['4', 1801],
            ['5', 613],
            ['6', 477],
            ['7', 204],
            ['8', 159],
            ['9+', 708]],
        'Lending': [['1', 82],
            ['2', 96],
            ['3', 41],
            ['4', 24],
            ['5', 16],
            ['6', 8],
            ['7', 11],
            ['8', 7],
            ['9+', 45]],
        'crvUSD': [['1', 335],
            ['2', 300],
            ['3', 160],
            ['4', 143],
            ['5', 94],
            ['6', 65],
            ['7', 76],
            ['8', 60],
            ['9+', 467]],
        'DAO': [['1', 68],
            ['2', 119],
            ['3', 23],
            ['4', 47],
            ['5', 13],
            ['6', 22],
            ['7', 4],
            ['8', 15],
            ['9+', 106]]},
    'all': {'DAO': [['1', 68],
            ['2', 119],
            ['3', 23],
            ['4', 47],
            ['5', 13],
            ['6', 22],
            ['7', 4],
            ['8', 15],
            ['9+', 106]],
        'All': [['1', 58966],
            ['2', 26236],
            ['3', 12830],
            ['4', 7156],
            ['5', 3953],
            ['6', 2413],
            ['7', 1500],
            ['8', 984],
            ['9+', 6223]]},
    'polygon': {'All': [['1', 11755],
            ['2', 3865],
            ['3', 1212],
            ['4', 399],
            ['5', 132],
            ['6', 102],
            ['7', 58],
            ['8', 47],
            ['9+', 353]],
        'Trading': [['1', 1310],
            ['2', 69],
            ['3', 30],
            ['4', 13],
            ['5', 11],
            ['6', 24],
            ['7', 9],
            ['8', 9],
            ['9+', 134]],
        'UI Router': [['1', 8868],
            ['2', 3343],
            ['3', 1030],
            ['4', 296],
            ['5', 88],
            ['6', 58],
            ['7', 17],
            ['8', 16],
            ['9+', 74]],
        'LP': [['1', 2076],
            ['2', 645],
            ['3', 161],
            ['4', 85],
            ['5', 43],
            ['6', 28],
            ['7', 24],
            ['8', 20],
            ['9+', 121]],
        'Lending': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'crvUSD': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'DAO': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]]},
    'arbitrum': {'All': [['1', 10961],
            ['2', 3274],
            ['3', 1291],
            ['4', 723],
            ['5', 438],
            ['6', 356],
            ['7', 265],
            ['8', 194],
            ['9+', 1527]],
        'Trading': [['1', 3638],
            ['2', 617],
            ['3', 245],
            ['4', 102],
            ['5', 79],
            ['6', 57],
            ['7', 29],
            ['8', 22],
            ['9+', 297]],
        'UI Router': [['1', 7158],
            ['2', 2254],
            ['3', 746],
            ['4', 412],
            ['5', 227],
            ['6', 170],
            ['7', 117],
            ['8', 73],
            ['9+', 427]],
        'LP': [['1', 2133],
            ['2', 1253],
            ['3', 434],
            ['4', 320],
            ['5', 195],
            ['6', 157],
            ['7', 106],
            ['8', 113],
            ['9+', 592]],
        'Lending': [['1', 49],
            ['2', 107],
            ['3', 63],
            ['4', 45],
            ['5', 31],
            ['6', 24],
            ['7', 15],
            ['8', 22],
            ['9+', 129]],
        'crvUSD': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'DAO': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]]},
    'optimism': {'All': [['1', 4634],
            ['2', 1610],
            ['3', 546],
            ['4', 297],
            ['5', 139],
            ['6', 85],
            ['7', 52],
            ['8', 47],
            ['9+', 271]],
        'Trading': [['1', 728],
            ['2', 343],
            ['3', 244],
            ['4', 128],
            ['5', 50],
            ['6', 30],
            ['7', 8],
            ['8', 10],
            ['9+', 95]],
        'UI Router': [['1', 3310],
            ['2', 1048],
            ['3', 219],
            ['4', 111],
            ['5', 52],
            ['6', 22],
            ['7', 17],
            ['8', 16],
            ['9+', 73]],
        'LP': [['1', 1147],
            ['2', 369],
            ['3', 107],
            ['4', 77],
            ['5', 29],
            ['6', 28],
            ['7', 17],
            ['8', 20],
            ['9+', 76]],
        'Lending': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'crvUSD': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'DAO': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]]},
    'base': {'All': [['1', 14751],
            ['2', 5520],
            ['3', 1497],
            ['4', 702],
            ['5', 269],
            ['6', 182],
            ['7', 87],
            ['8', 64],
            ['9+', 381]],
        'Trading': [['1', 148],
            ['2', 40],
            ['3', 29],
            ['4', 34],
            ['5', 21],
            ['6', 29],
            ['7', 16],
            ['8', 4],
            ['9+', 96]],
        'UI Router': [['1', 14315],
            ['2', 5123],
            ['3', 1378],
            ['4', 537],
            ['5', 186],
            ['6', 105],
            ['7', 56],
            ['8', 40],
            ['9+', 174]],
        'LP': [['1', 1034],
            ['2', 800],
            ['3', 99],
            ['4', 80],
            ['5', 29],
            ['6', 21],
            ['7', 12],
            ['8', 19],
            ['9+', 61]],
        'Lending': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'crvUSD': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'DAO': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]]},
    'fantom': {'All': [['1', 660],
            ['2', 123],
            ['3', 68],
            ['4', 27],
            ['5', 15],
            ['6', 19],
            ['7', 10],
            ['8', 8],
            ['9+', 112]],
        'Trading': [['1', 338],
            ['2', 20],
            ['3', 16],
            ['4', 3],
            ['5', 3],
            ['6', 5],
            ['7', 4],
            ['8', 2],
            ['9+', 75]],
        'UI Router': [['1', 213],
            ['2', 85],
            ['3', 31],
            ['4', 16],
            ['5', 7],
            ['6', 7],
            ['7', 6],
            ['8', 4],
            ['9+', 15]],
        'LP': [['1', 170],
            ['2', 32],
            ['3', 14],
            ['4', 12],
            ['5', 3],
            ['6', 6],
            ['7', 1],
            ['8', 7],
            ['9+', 31]],
        'Lending': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'crvUSD': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'DAO': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]]},
    'fraxtal': {'All': [['1', 145],
            ['2', 98],
            ['3', 56],
            ['4', 37],
            ['5', 21],
            ['6', 29],
            ['7', 19],
            ['8', 8],
            ['9+', 135]],
        'Trading': [['1', 42],
            ['2', 16],
            ['3', 8],
            ['4', 5],
            ['5', 1],
            ['6', 3],
            ['7', 2],
            ['8', 0],
            ['9+', 28]],
        'UI Router': [['1', 134],
            ['2', 78],
            ['3', 47],
            ['4', 34],
            ['5', 12],
            ['6', 13],
            ['7', 12],
            ['8', 6],
            ['9+', 65]],
        'LP': [['1', 119],
            ['2', 57],
            ['3', 30],
            ['4', 14],
            ['5', 21],
            ['6', 7],
            ['7', 9],
            ['8', 11],
            ['9+', 44]],
        'Lending': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'crvUSD': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'DAO': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]]},
    'xdai': {'All': [['1', 577],
            ['2', 130],
            ['3', 42],
            ['4', 28],
            ['5', 16],
            ['6', 8],
            ['7', 8],
            ['8', 4],
            ['9+', 62]],
        'Trading': [['1', 480],
            ['2', 48],
            ['3', 10],
            ['4', 8],
            ['5', 8],
            ['6', 1],
            ['7', 3],
            ['8', 2],
            ['9+', 34]],
        'UI Router': [['1', 126],
            ['2', 64],
            ['3', 18],
            ['4', 8],
            ['5', 7],
            ['6', 5],
            ['7', 2],
            ['8', 3],
            ['9+', 18]],
        'LP': [['1', 65],
            ['2', 17],
            ['3', 8],
            ['4', 6],
            ['5', 2],
            ['6', 3],
            ['7', 1],
            ['8', 0],
            ['9+', 21]],
        'Lending': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'crvUSD': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]],
        'DAO': [['1.0', 0],
            ['2.0', 0],
            ['3.0', 0],
            ['4.0', 0],
            ['5.0', 0],
            ['6.0', 0],
            ['7.0', 0],
            ['8.0', 0],
            ['9.0+', 0]]}}
let transactionHistogramChart;

function createTransactionProductSelector(elementId, onChangeCallback) {
    const selectElement = document.getElementById(elementId);
    if (!selectElement) {
        console.error(`Element with id "${elementId}" not found`);
        return null;
    }

    selectElement.innerHTML = '';

    transactionProductList.forEach(product => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        selectElement.appendChild(option);
    });

    selectElement.addEventListener('change', (event) => {
        onChangeCallback(event.target.value);
    });

    return selectElement.value;
}

function createTransactionHistogramChart(chainData, product) {
    const ctx = document.getElementById('transactionHistogramChart').getContext('2d');

    if (transactionHistogramChart) {
        transactionHistogramChart.destroy();
    }

    if (!chainData || !chainData[product]) {
        displayTransactionErrorMessage(`No data available for ${product} on this chain.`);
        return;
    }

    const labels = chainData[product].map(item => item[0]);
    const values = chainData[product].map(item => item[1]);

    transactionHistogramChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: `${product} Transaction Count Distribution`,
                data: values,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Users'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Number of Transactions'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `${product} Transaction Count Distribution`
                },
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Users: ${context.parsed.y}`;
                        }
                    }
                }
            }
        }
    });
}

function displayTransactionErrorMessage(message) {
    const ctx = document.getElementById('transactionHistogramChart').getContext('2d');
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.font = '20px Arial';
    ctx.fillStyle = 'red';
    ctx.textAlign = 'center';
    ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
}

function updateTransactionHistogramChart(selectedChain, selectedProduct) {
    if (transactionHistogramData[selectedChain] && transactionHistogramData[selectedChain][selectedProduct]) {
        createTransactionHistogramChart(transactionHistogramData[selectedChain], selectedProduct);
    } else {
        displayTransactionErrorMessage(`Data not available for chain: ${selectedChain}, product: ${selectedProduct}`);
    }
}

function updateTransactionProductSelector(selectedChain) {
    const productSelect = document.getElementById('productSelectTransactionHistogram');
    productSelect.innerHTML = '';

    transactionProductList.forEach(product => {
        if (transactionHistogramData[selectedChain] && transactionHistogramData[selectedChain][product]) {
            const option = document.createElement('option');
            option.value = product;
            option.textContent = product;
            productSelect.appendChild(option);
        }
    });

    if (!productSelect.querySelector('option[value="All"]')) {
        const allOption = document.createElement('option');
        allOption.value = 'All';
        allOption.textContent = 'All';
        productSelect.insertBefore(allOption, productSelect.firstChild);
    }
    productSelect.value = 'All';
}

document.addEventListener('DOMContentLoaded', () => {
    const chainSelect = document.getElementById('chainSelectTransactionHistogram');
    const productSelect = document.getElementById('productSelectTransactionHistogram');

    const initialChain = createChainSelector('chainSelectTransactionHistogram', (chain) => {
        updateTransactionProductSelector(chain);
        updateTransactionHistogramChart(chain, productSelect.value);
    });

    createTransactionProductSelector('productSelectTransactionHistogram', (product) => {
        updateTransactionHistogramChart(chainSelect.value, product);
    });

    chainSelect.value = initialChain || 'all';
    updateTransactionProductSelector(chainSelect.value);
    productSelect.value = 'All';

    updateTransactionHistogramChart(chainSelect.value, productSelect.value);
});