const transitionsChainData ={'ethereum': {'DAO': {'DAO': 81.34715025906736, 'Trading': 0.023918867202449293, 'LP': 0.1937292888095845, 'UI Router': 0.07082487369564192, 'crvUSD': 0.0, 'Lending': 0.0}, 'Trading': {'DAO': 1.5544041450777202, 'Trading': 27.08572522005358, 'LP': 4.364007137394851, 'UI Router': 2.8707682137966857, 'crvUSD': 1.3531799729364005, 'Lending': 1.639344262295082}, 'LP': {'DAO': 3.6269430051813467, 'Trading': 22.9716800612323, 'LP': 51.582972215141474, 'UI Router': 10.07129703952028, 'crvUSD': 1.6238159675236805, 'Lending': 0.0}, 'UI Router': {'DAO': 3.1088082901554404, 'Trading': 4.200153080750096, 'LP': 4.1651797094060665, 'UI Router': 29.595353888285565, 'crvUSD': 5.953991880920163, 'Lending': 12.295081967213115}, 'crvUSD': {'DAO': 0.0, 'Trading': 0.06218905472636816, 'LP': 0.07647208768799389, 'UI Router': 0.21247462108692572, 'crvUSD': 74.83085250338294, 'Lending': 1.639344262295082}, 'Lending': {'DAO': 0.0, 'Trading': 0.052621507845388445, 'LP': 0.04078511343359673, 'UI Router': 0.08971150668114643, 'crvUSD': 0.20297699594046006, 'Lending': 54.09836065573771}}, 'polygon': {'Trading': {'Trading': 14.786264891380519, 'LP': 1.4903129657228018, 'UI Router': 0.36651395251978347}, 'LP': {'Trading': 2.242466713384723, 'LP': 31.892697466467958, 'UI Router': 1.0329029571012078}, 'UI Router': {'Trading': 0.2803083391730904, 'LP': 3.055141579731744, 'UI Router': 62.748854643898376}}, 'arbitrum': {'Trading': {'Trading': 26.058884297520663, 'LP': 4.843654199877376, 'UI Router': 2.3892052488239663, 'Lending': 0.0}, 'LP': {'Trading': 3.0991735537190084, 'LP': 50.98099325567137, 'UI Router': 6.152512998266898, 'Lending': 2.7777777777777777}, 'UI Router': {'Trading': 3.460743801652893, 'LP': 6.897608828939301, 'UI Router': 44.62738301559792, 'Lending': 25.396825396825395}, 'Lending': {'Trading': 0.0, 'LP': 0.2145922746781116, 'UI Router': 0.19806882891804903, 'Lending': 62.301587301587304}}, 'optimism': {'Trading': {'Trading': 62.75805119735756, 'LP': 3.345070422535211, 'UI Router': 1.1047874121191832}, 'LP': {'Trading': 2.477291494632535, 'LP': 28.433098591549292, 'UI Router': 3.8834951456310676}, 'UI Router': {'Trading': 2.3947151114781176, 'LP': 5.633802816901409, 'UI Router': 38.366253766320725}}, 'base': {'Trading': {'Trading': 69.68641114982579, 'LP': 2.1593447505584513, 'UI Router': 0.33096347143907817}, 'LP': {'Trading': 4.878048780487805, 'LP': 46.09084139985108, 'UI Router': 1.9122333905368962}, 'UI Router': {'Trading': 1.3937282229965158, 'LP': 8.637379002233805, 'UI Router': 37.24564844324589}}, 'fantom': {'Trading': {'Trading': 23.27790973871734, 'LP': 4.5, 'UI Router': 0.0}, 'LP': {'Trading': 1.66270783847981, 'LP': 34.5, 'UI Router': 1.1627906976744187}, 'UI Router': {'Trading': 1.187648456057007, 'LP': 6.5, 'UI Router': 45.348837209302324}}, 'fraxtal': {'Trading': {'Trading': 47.82608695652174, 'LP': 23.333333333333332, 'UI Router': 1.3605442176870748}, 'LP': {'Trading': 28.26086956521739, 'LP': 25.0, 'UI Router': 13.60544217687075}, 'UI Router': {'Trading': 4.3478260869565215, 'LP': 16.666666666666664, 'UI Router': 57.14285714285714}}, 'xdai': {'Trading': {'Trading': 15.79925650557621, 'LP': 16.666666666666664, 'UI Router': 3.048780487804878}, 'LP': {'Trading': 1.486988847583643, 'LP': 30.555555555555557, 'UI Router': 4.878048780487805}, 'UI Router': {'Trading': 2.2304832713754648, 'LP': 12.5, 'UI Router': 52.4390243902439}}, 'all': {'DAO': {'DAO': 81.34715025906736, 'Trading': 0.01741856819369448, 'LP': 0.13745946708021994, 'UI Router': 0.027768703038222802, 'crvUSD': 0.0, 'Lending': 0.0}, 'Trading': {'DAO': 1.5544041450777202, 'Trading': 28.029959937293153, 'LP': 4.074439588326519, 'UI Router': 1.533812479581836, 'crvUSD': 1.3531799729364005, 'Lending': 0.53475935828877}, 'LP': {'DAO': 3.6269430051813467, 'Trading': 17.50914474830169, 'LP': 48.23417453827717, 'UI Router': 5.249918327344005, 'crvUSD': 1.6238159675236805, 'Lending': 1.8716577540106951}, 'UI Router': {'DAO': 3.1088082901554404, 'Trading': 3.72060616617314, 'LP': 4.708867897927535, 'UI Router': 40.76282260699118, 'crvUSD': 5.953991880920163, 'Lending': 21.12299465240642}, 'crvUSD': {'DAO': 0.0, 'Trading': 0.04528827730360564, 'LP': 0.06696743268010714, 'UI Router': 0.07350539039529566, 'crvUSD': 74.83085250338294, 'Lending': 0.53475935828877}, 'Lending': {'DAO': 0.0, 'Trading': 0.03832085002612785, 'LP': 0.07049203440011279, 'UI Router': 0.0637046716759229, 'crvUSD': 0.20297699594046006, 'Lending': 59.62566844919787}}}
let transitionsChart;

function createTransitionsHeatmap(data, selectedChain) {
    const transitionsLabels = Object.keys(data[selectedChain]);
    const transitionsSeriesData = transitionsLabels.flatMap((label, i) =>
        transitionsLabels.map((innerLabel, j) => ({
            x: innerLabel,
            y: data[selectedChain][label][innerLabel].toFixed(2)
        }))
    );

    const transitionsOptions = {
        series: transitionsLabels.map((label, index) => ({
            name: label,
            data: transitionsSeriesData.slice(index * transitionsLabels.length, (index + 1) * transitionsLabels.length)
        })),
        chart: {
            height: 450,
            type: 'heatmap',
        },
        dataLabels: {
            enabled: true,
            style: {
                colors: ['#222']
            },
            formatter: function (value, {seriesIndex, dataPointIndex, w}) {
                return value + '%';
            }
        },
        colors: ["#FFB3BA"],
        title: {
            text: `Transitions Between Curve Products (%) on ${selectedChain === 'all' ? 'all chains' : selectedChain}`
        },
        xaxis: {
            type: 'category',
            categories: transitionsLabels,
            tooltip: {
                enabled: false
            }
        },
        tooltip: {
            y: {
                formatter: function (value, {seriesIndex, dataPointIndex, w}) {
                    let x = w.config.xaxis.categories[dataPointIndex];
                    let y = w.config.series[seriesIndex].name;
                    return `${value}% of ${y} users transition to ${x} ${selectedChain === 'all' ? '' : 'on ' + selectedChain}`;
                },
                title: {
                    formatter: () => ''
                }
            }
        }
    };

    if (transitionsChart) {
        transitionsChart.destroy();
    }

    transitionsChart = new ApexCharts(document.querySelector("#transitionsHeatmapChart"), transitionsOptions);
    transitionsChart.render();
}

function updateTransitionsHeatMapChart(selectedChain) {
    createTransitionsHeatmap(transitionsChainData, selectedChain);
}

document.addEventListener('DOMContentLoaded', () => {
    const initialChainTransitionsHeatmap = createChainSelector('chainSelectTransitionsHeatmap', updateTransitionsHeatMapChart);
    if (initialChainTransitionsHeatmap) {
        updateTransitionsHeatMapChart(initialChainTransitionsHeatmap);
    } else {
        console.error('Failed to initialize transitions chain selector');
    }
});